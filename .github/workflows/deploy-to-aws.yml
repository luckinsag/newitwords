name: ğŸš€ IT Words Learning - AWS EC2 è‡ªåŠ¨éƒ¨ç½²

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸŒŸ å¼€å§‹éƒ¨ç½²æµç¨‹
      run: |
        echo "ğŸš€ å¼€å§‹ IT Words Learning é¡¹ç›®è‡ªåŠ¨éƒ¨ç½²"
        echo "================================================="
        echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸŒ éƒ¨ç½²ç¯å¢ƒ: AWS EC2"
        echo "ğŸ“¦ Node.js ç‰ˆæœ¬: ${{ env.NODE_VERSION }}"
        echo "â˜• Java ç‰ˆæœ¬: ${{ env.JAVA_VERSION }}"
        echo "================================================="

    - name: ğŸ” æ£€æŸ¥é¡¹ç›®ç»“æ„
      run: |
        echo "ğŸ” æ£€æŸ¥é¡¹ç›®æ ¹ç›®å½•ç»“æ„..."
        ls -la
        echo ""
        echo "ğŸ“ æ£€æŸ¥ code-and-project-files ç›®å½•..."
        ls -la code-and-project-files/ || echo "âŒ code-and-project-files ç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "ğŸ“ æ£€æŸ¥ project-structure ç›®å½•..."
        ls -la project-structure/ || echo "âŒ project-structure ç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "ğŸ“ æ£€æŸ¥ project-structure/frontend-app ç›®å½•..."
        ls -la project-structure/frontend-app/ || echo "âŒ project-structure/frontend-app ç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "ğŸ“ æ£€æŸ¥ project-structure/backend-api ç›®å½•..."
        ls -la project-structure/backend-api/ || echo "âŒ project-structure/backend-api ç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "ğŸ“ æ£€æŸ¥ scripts-and-configs ç›®å½•..."
        ls -la scripts-and-configs/ || echo "âŒ scripts-and-configs ç›®å½•ä¸å­˜åœ¨"

    - name: ğŸ”§ é…ç½® Node.js ç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'code-and-project-files/package-lock.json'
        
    - name: âœ… Node.js ç¯å¢ƒé…ç½®å®Œæˆ
      run: |
        echo "âœ… Node.js ç¯å¢ƒé…ç½®å®Œæˆ"
        echo "ğŸ“¦ Node.js ç‰ˆæœ¬: $(node --version)"
        echo "ğŸ“¦ npm ç‰ˆæœ¬: $(npm --version)"

    - name: â˜• é…ç½® Java ç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: âœ… Java ç¯å¢ƒé…ç½®å®Œæˆ
      run: |
        echo "âœ… Java ç¯å¢ƒé…ç½®å®Œæˆ"
        echo "â˜• Java ç‰ˆæœ¬: $(java --version | head -1)"
        echo "ğŸ”¨ Maven ç‰ˆæœ¬: $(mvn --version | head -1)"

    - name: ğŸ“¦ ç¼“å­˜ Maven ä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: ğŸ“‚ å‡†å¤‡é¡¹ç›®æ–‡ä»¶
      run: |
        echo "ğŸ“‚ å¼€å§‹å‡†å¤‡é¡¹ç›®æ–‡ä»¶..."
        
        # Create build directories
        echo "ğŸ“ åˆ›å»ºæ„å»ºç›®å½•..."
        mkdir -p build/frontend-app
        mkdir -p build/backend-api
        echo "âœ… æ„å»ºç›®å½•åˆ›å»ºå®Œæˆ"
        
        # æ£€æŸ¥å¿…éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„å‰ç«¯æ–‡ä»¶..."
        if [ ! -f "code-and-project-files/package.json" ]; then
          echo "âŒ package.json æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        if [ ! -f "code-and-project-files/package-lock.json" ]; then
          echo "âŒ package-lock.json æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        if [ ! -f "code-and-project-files/vite.config.js" ]; then
          echo "âŒ vite.config.js æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        if [ ! -f "code-and-project-files/index.html" ]; then
          echo "âŒ index.html æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        if [ ! -d "project-structure/frontend-app/src" ]; then
          echo "âŒ project-structure/frontend-app/src ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        if [ ! -d "project-structure/frontend-app/public" ]; then
          echo "âŒ project-structure/frontend-app/public ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        if [ ! -f "code-and-project-files/App.vue" ]; then
          echo "âŒ App.vue æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        if [ ! -f "code-and-project-files/main.js" ]; then
          echo "âŒ main.js æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        echo "âœ… å‰ç«¯å¿…éœ€æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
        
        echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„åç«¯æ–‡ä»¶..."
        if [ ! -f "code-and-project-files/pom.xml" ]; then
          echo "âŒ pom.xml æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        if [ ! -f "code-and-project-files/mvnw" ]; then
          echo "âŒ mvnw æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        if [ ! -f "code-and-project-files/mvnw.cmd" ]; then
          echo "âŒ mvnw.cmd æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        if [ ! -d "project-structure/backend-api/src" ]; then
          echo "âŒ project-structure/backend-api/src ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        if [ ! -d "project-structure/backend-api/.mvn" ]; then
          echo "âŒ project-structure/backend-api/.mvn ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        echo "âœ… åç«¯å¿…éœ€æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
        
        # Copy frontend files
        echo "ğŸ¨ å¤åˆ¶å‰ç«¯æ–‡ä»¶..."
        cp code-and-project-files/package.json build/frontend-app/
        cp code-and-project-files/package-lock.json build/frontend-app/
        cp code-and-project-files/vite.config.js build/frontend-app/
        cp code-and-project-files/index.html build/frontend-app/
        cp -r project-structure/frontend-app/src build/frontend-app/
        cp -r project-structure/frontend-app/public build/frontend-app/
        # Override with main app files
        cp code-and-project-files/App.vue build/frontend-app/src/
        cp code-and-project-files/main.js build/frontend-app/src/
        echo "âœ… å‰ç«¯æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        
        # Copy backend files
        echo "âš™ï¸ å¤åˆ¶åç«¯æ–‡ä»¶..."
        cp code-and-project-files/pom.xml build/backend-api/
        cp code-and-project-files/mvnw build/backend-api/
        cp code-and-project-files/mvnw.cmd build/backend-api/
        cp -r project-structure/backend-api/src build/backend-api/
        cp -r project-structure/backend-api/.mvn build/backend-api/
        echo "âœ… åç«¯æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        
        echo "ğŸ“Š æ£€æŸ¥å¤åˆ¶åçš„æ–‡ä»¶ç»“æ„..."
        echo "å‰ç«¯æ„å»ºç›®å½•:"
        ls -la build/frontend-app/
        echo "åç«¯æ„å»ºç›®å½•:"
        ls -la build/backend-api/
        
        echo "ğŸ‰ é¡¹ç›®æ–‡ä»¶å‡†å¤‡å®Œæˆï¼"
        
    - name: ğŸ¨ æ„å»ºå‰ç«¯åº”ç”¨
      run: |
        echo "ğŸ¨ å¼€å§‹æ„å»ºå‰ç«¯åº”ç”¨..."
        cd build/frontend-app
        
        echo "ğŸ“Š å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        
        echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
        npm ci
        echo "âœ… å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ"
        
        echo "ğŸ”¨ æ„å»ºå‰ç«¯åº”ç”¨..."
        npm run build
        echo "âœ… å‰ç«¯åº”ç”¨æ„å»ºå®Œæˆ"
        
        echo "ğŸ“Š æ„å»ºç»“æœ:"
        ls -la dist/
        
    - name: âš™ï¸ æ„å»ºåç«¯åº”ç”¨
      run: |
        echo "âš™ï¸ å¼€å§‹æ„å»ºåç«¯åº”ç”¨..."
        cd build/backend-api
        
        echo "ğŸ“Š å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        
        echo "ğŸ”‘ è®¾ç½®æ‰§è¡Œæƒé™..."
        chmod +x mvnw
        echo "âœ… æ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"
        
        echo "ğŸ”¨ æ„å»ºåç«¯åº”ç”¨ (è·³è¿‡æµ‹è¯•)..."
        ./mvnw clean package -DskipTests
        echo "âœ… åç«¯åº”ç”¨æ„å»ºå®Œæˆ"
        
        echo "ğŸ“Š æ„å»ºç»“æœ:"
        ls -la target/*.jar

    - name: ğŸ“¦ åˆ›å»ºéƒ¨ç½²åŒ…
      run: |
        echo "ğŸ“¦ å¼€å§‹åˆ›å»ºéƒ¨ç½²åŒ…..."
        mkdir -p deploy
        
        # Copy frontend build
        echo "ğŸ¨ å¤åˆ¶å‰ç«¯æ„å»ºæ–‡ä»¶..."
        cp -r build/frontend-app/dist deploy/frontend
        echo "âœ… å‰ç«¯æ„å»ºæ–‡ä»¶å¤åˆ¶å®Œæˆ"
        
        # Copy backend JAR
        echo "âš™ï¸ å¤åˆ¶åç«¯ JAR æ–‡ä»¶..."
        cp build/backend-api/target/*.jar deploy/backend.jar
        echo "âœ… åç«¯ JAR æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        
        # æ£€æŸ¥éƒ¨ç½²è„šæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        echo "ğŸ” æ£€æŸ¥éƒ¨ç½²è„šæœ¬å’Œé…ç½®æ–‡ä»¶..."
        if [ ! -f "scripts-and-configs/database-setup.sql" ]; then
          echo "âŒ database-setup.sql æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        if [ ! -f "scripts-and-configs/nginx.conf" ]; then
          echo "âŒ nginx.conf æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        if [ ! -f "scripts-and-configs/docker-compose.yml" ]; then
          echo "âŒ docker-compose.yml æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        if [ ! -f "scripts-and-configs/production.properties" ]; then
          echo "âŒ production.properties æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        echo "âœ… éƒ¨ç½²è„šæœ¬å’Œé…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
        
        # Copy deployment scripts
        echo "ğŸ“‹ å¤åˆ¶éƒ¨ç½²è„šæœ¬å’Œé…ç½®æ–‡ä»¶..."
        cp scripts-and-configs/database-setup.sql deploy/
        cp scripts-and-configs/nginx.conf deploy/
        cp scripts-and-configs/docker-compose.yml deploy/
        cp scripts-and-configs/production.properties deploy/
        echo "âœ… éƒ¨ç½²è„šæœ¬å’Œé…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        
        # Create deployment script
        echo "ğŸ“ åˆ›å»º EC2 éƒ¨ç½²è„šæœ¬..."
        cat > deploy/deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ å¼€å§‹åœ¨ EC2 ä¸Šéƒ¨ç½² IT Words Learning..."
        echo "================================================="
        
        # Update system
        echo "ğŸ”„ æ›´æ–°ç³»ç»ŸåŒ…..."
        sudo yum update -y
        echo "âœ… ç³»ç»Ÿæ›´æ–°å®Œæˆ"
        
        # Install Docker if not exists
        if ! command -v docker &> /dev/null; then
            echo "ğŸ³ å®‰è£… Docker..."
            sudo yum install -y docker
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -a -G docker ec2-user
            echo "âœ… Docker å®‰è£…å®Œæˆ"
        else
            echo "âœ… Docker å·²å®‰è£…"
        fi
        
        # Install Docker Compose if not exists
        if ! command -v docker-compose &> /dev/null; then
            echo "ğŸ³ å®‰è£… Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            echo "âœ… Docker Compose å®‰è£…å®Œæˆ"
        else
            echo "âœ… Docker Compose å·²å®‰è£…"
        fi
        
        # Install Java 17 if not exists
        if ! command -v java &> /dev/null; then
            echo "â˜• å®‰è£… Java 17..."
            sudo yum install -y java-17-amazon-corretto-headless
            echo "âœ… Java 17 å®‰è£…å®Œæˆ"
        else
            echo "âœ… Java å·²å®‰è£…: $(java --version | head -1)"
        fi
        
        # Install MySQL if not exists
        if ! command -v mysql &> /dev/null; then
            echo "ğŸ—„ï¸ å®‰è£… MySQL..."
            sudo yum install -y mysql mysql-server
            sudo systemctl start mysqld
            sudo systemctl enable mysqld
            echo "âœ… MySQL å®‰è£…å®Œæˆ"
        else
            echo "âœ… MySQL å·²å®‰è£…"
        fi
        
        # Setup application directory
        echo "ğŸ“ è®¾ç½®åº”ç”¨ç›®å½•..."
        sudo mkdir -p /opt/itwords
        sudo chown ec2-user:ec2-user /opt/itwords
        echo "âœ… åº”ç”¨ç›®å½•è®¾ç½®å®Œæˆ"
        
        # Copy files
        echo "ğŸ“„ å¤åˆ¶åº”ç”¨æ–‡ä»¶..."
        cp backend.jar /opt/itwords/
        cp -r frontend /opt/itwords/
        cp database-setup.sql /opt/itwords/
        cp nginx.conf /opt/itwords/
        cp docker-compose.yml /opt/itwords/
        cp production.properties /opt/itwords/application.properties
        echo "âœ… åº”ç”¨æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        
        # Setup database
        echo "ğŸ—„ï¸ è®¾ç½®æ•°æ®åº“..."
        if ! mysql -u root -e "USE mysql_itwordslearning;" 2>/dev/null; then
            echo "ğŸ—„ï¸ åˆ›å»ºæ•°æ®åº“å’Œè¡¨..."
            mysql -u root < database-setup.sql
            echo "âœ… æ•°æ®åº“è®¾ç½®å®Œæˆ"
        else
            echo "âœ… æ•°æ®åº“å·²å­˜åœ¨"
        fi
        
        # Stop existing services
        echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
        sudo pkill -f "backend.jar" || true
        sudo systemctl stop nginx || true
        echo "âœ… ç°æœ‰æœåŠ¡å·²åœæ­¢"
        
        # Install and configure Nginx
        if ! command -v nginx &> /dev/null; then
            echo "ğŸŒ å®‰è£… Nginx..."
            sudo yum install -y nginx
            echo "âœ… Nginx å®‰è£…å®Œæˆ"
        else
            echo "âœ… Nginx å·²å®‰è£…"
        fi
        
        echo "ğŸŒ é…ç½® Nginx..."
        sudo cp nginx.conf /etc/nginx/nginx.conf
        sudo systemctl start nginx
        sudo systemctl enable nginx
        echo "âœ… Nginx é…ç½®å®Œæˆ"
        
        # Start backend service
        echo "âš™ï¸ å¯åŠ¨åç«¯æœåŠ¡..."
        cd /opt/itwords
        nohup java -jar backend.jar --spring.config.location=application.properties > app.log 2>&1 &
        echo "âœ… åç«¯æœåŠ¡å¯åŠ¨å®Œæˆ"
        
        # Wait for services to start
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 10
        
        echo "================================================="
        echo "ğŸ‰ IT Words Learning éƒ¨ç½²å®Œæˆï¼"
        echo "================================================="
        echo "ğŸŒ å‰ç«¯è®¿é—®åœ°å€: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)"
        echo "âš™ï¸ åç«¯ API åœ°å€: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):8080"
        echo "ğŸ“Š å¥åº·æ£€æŸ¥: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):8080/actuator/health"
        echo "================================================="
        EOF
        
        chmod +x deploy/deploy.sh
        echo "âœ… EC2 éƒ¨ç½²è„šæœ¬åˆ›å»ºå®Œæˆ"
        
        # Create archive
        echo "ğŸ“¦ åˆ›å»ºéƒ¨ç½²å‹ç¼©åŒ…..."
        tar -czf deployment.tar.gz -C deploy .
        echo "âœ… éƒ¨ç½²åŒ…åˆ›å»ºå®Œæˆ"
        
        echo "ğŸ“Š éƒ¨ç½²åŒ…å†…å®¹:"
        tar -tzf deployment.tar.gz

    - name: ğŸ” é…ç½® AWS å‡­è¯
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
        
    - name: âœ… AWS å‡­è¯é…ç½®å®Œæˆ
      run: |
        echo "âœ… AWS å‡­è¯é…ç½®å®Œæˆ"
        echo "ğŸŒ AWS åŒºåŸŸ: ${{ secrets.AWS_REGION }}"
        echo "ğŸª£ S3 å­˜å‚¨æ¡¶: ${{ secrets.S3_BUCKET }}"

    - name: ğŸš€ ä¸Šä¼ éƒ¨ç½²åŒ…åˆ° S3
      run: |
        echo "ğŸš€ å¼€å§‹ä¸Šä¼ éƒ¨ç½²åŒ…åˆ° S3..."
        
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        echo "ğŸ“… éƒ¨ç½²æ—¶é—´æˆ³: $TIMESTAMP"
        
        echo "ğŸ“¤ ä¸Šä¼ å¸¦æ—¶é—´æˆ³çš„éƒ¨ç½²åŒ…..."
        aws s3 cp deployment.tar.gz s3://${{ secrets.S3_BUCKET }}/deployments/deployment-$TIMESTAMP.tar.gz
        echo "âœ… å¸¦æ—¶é—´æˆ³çš„éƒ¨ç½²åŒ…ä¸Šä¼ å®Œæˆ"
        
        echo "ğŸ“¤ ä¸Šä¼ æœ€æ–°ç‰ˆæœ¬éƒ¨ç½²åŒ…..."
        aws s3 cp deployment.tar.gz s3://${{ secrets.S3_BUCKET }}/deployments/latest.tar.gz
        echo "âœ… æœ€æ–°ç‰ˆæœ¬éƒ¨ç½²åŒ…ä¸Šä¼ å®Œæˆ"
        
        echo "ğŸ“Š S3 å­˜å‚¨æ¡¶å†…å®¹:"
        aws s3 ls s3://${{ secrets.S3_BUCKET }}/deployments/ --human-readable

    - name: ğŸŒ éƒ¨ç½²åˆ° EC2 å®ä¾‹
      run: |
        echo "ğŸŒ å¼€å§‹éƒ¨ç½²åˆ° EC2 å®ä¾‹..."
        echo "ğŸ–¥ï¸ ç›®æ ‡æœåŠ¡å™¨: ${{ secrets.EC2_HOST }}"
        
        # Create temporary key file
        echo "ğŸ”‘ åˆ›å»ºä¸´æ—¶å¯†é’¥æ–‡ä»¶..."
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > ec2-key.pem
        chmod 600 ec2-key.pem
        echo "âœ… ä¸´æ—¶å¯†é’¥æ–‡ä»¶åˆ›å»ºå®Œæˆ"
        
        # Deploy to EC2
        echo "ğŸš€ è¿æ¥åˆ° EC2 å®ä¾‹å¹¶æ‰§è¡Œéƒ¨ç½²..."
        ssh -i ec2-key.pem -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          echo "ğŸ“¥ ä» S3 ä¸‹è½½æœ€æ–°éƒ¨ç½²åŒ…..."
          aws s3 cp s3://${{ secrets.S3_BUCKET }}/deployments/latest.tar.gz /tmp/
          echo "âœ… éƒ¨ç½²åŒ…ä¸‹è½½å®Œæˆ"
          
          echo "ğŸ“¦ è§£å‹éƒ¨ç½²åŒ…..."
          cd /tmp
          tar -xzf latest.tar.gz
          chmod +x deploy.sh
          echo "âœ… éƒ¨ç½²åŒ…è§£å‹å®Œæˆ"
          
          echo "ğŸš€ æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
          ./deploy.sh
          
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf /tmp/latest.tar.gz /tmp/deploy.sh /tmp/frontend /tmp/backend.jar /tmp/*.sql /tmp/*.conf /tmp/*.yml /tmp/*.properties
          echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
        EOF
        
        # Cleanup
        echo "ğŸ§¹ æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶..."
        rm -f ec2-key.pem
        echo "âœ… æœ¬åœ°ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"

    - name: ğŸ” åº”ç”¨å¥åº·æ£€æŸ¥
      run: |
        echo "ğŸ” å¼€å§‹åº”ç”¨å¥åº·æ£€æŸ¥..."
        echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨ (30ç§’)..."
        sleep 30
        
        # Check if backend is running
        echo "ğŸ” æ£€æŸ¥åç«¯æœåŠ¡å¥åº·çŠ¶æ€..."
        if curl -f http://${{ secrets.EC2_HOST }}:8080/actuator/health 2>/dev/null; then
          echo "âœ… åç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
          echo "ğŸ“Š åç«¯æœåŠ¡çŠ¶æ€: è¿è¡Œæ­£å¸¸"
        else
          echo "âŒ åç«¯æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
          echo "ğŸš¨ åç«¯æœåŠ¡å¯èƒ½æœªæ­£å¸¸å¯åŠ¨"
          exit 1
        fi
        
        # Check if frontend is accessible
        echo "ğŸ” æ£€æŸ¥å‰ç«¯æœåŠ¡è®¿é—®çŠ¶æ€..."
        if curl -f http://${{ secrets.EC2_HOST }} 2>/dev/null; then
          echo "âœ… å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
          echo "ğŸ“Š å‰ç«¯æœåŠ¡çŠ¶æ€: è¿è¡Œæ­£å¸¸"
        else
          echo "âŒ å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
          echo "ğŸš¨ å‰ç«¯æœåŠ¡å¯èƒ½æœªæ­£å¸¸å¯åŠ¨"
          exit 1
        fi
        
        echo "ğŸ‰ æ‰€æœ‰æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡ï¼"

    - name: ğŸ“‹ éƒ¨ç½²çŠ¶æ€é€šçŸ¥
      if: always()
      run: |
        echo "================================================="
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ IT Words Learning éƒ¨ç½²æˆåŠŸï¼"
          echo "================================================="
          echo "ğŸŒ å‰ç«¯è®¿é—®åœ°å€: http://${{ secrets.EC2_HOST }}"
          echo "âš™ï¸ åç«¯ API åœ°å€: http://${{ secrets.EC2_HOST }}:8080"
          echo "ğŸ“Š å¥åº·æ£€æŸ¥åœ°å€: http://${{ secrets.EC2_HOST }}:8080/actuator/health"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸš€ éƒ¨ç½²ç¯å¢ƒ: AWS EC2"
          echo "================================================="
          echo "ğŸ¯ å¯ä»¥å¼€å§‹ä½¿ç”¨ IT Words Learning ç³»ç»Ÿäº†ï¼"
        else
          echo "ğŸ’¥ IT Words Learning éƒ¨ç½²å¤±è´¥ï¼"
          echo "================================================="
          echo "ğŸš¨ éƒ¨ç½²è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          echo "ğŸ“‹ å¸¸è§é—®é¢˜æ’æŸ¥:"
          echo "   1. æ£€æŸ¥ GitHub Secrets é…ç½®"
          echo "   2. æ£€æŸ¥ AWS æƒé™è®¾ç½®"
          echo "   3. æ£€æŸ¥ EC2 å®ä¾‹çŠ¶æ€"
          echo "   4. æ£€æŸ¥ç½‘ç»œè¿æ¥"
          echo "   5. æ£€æŸ¥é¡¹ç›®æ–‡ä»¶ç»“æ„"
          echo "================================================="
        fi

  cleanup:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: ğŸ§¹ æ¸…ç†æ—§éƒ¨ç½²æ–‡ä»¶
      run: |
        echo "ğŸ§¹ å¼€å§‹æ¸…ç† S3 ä¸­çš„æ—§éƒ¨ç½²æ–‡ä»¶..."
        
        # Configure AWS
        echo "ğŸ” é…ç½® AWS å‡­è¯..."
        aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws configure set default.region ${{ secrets.AWS_REGION }}
        echo "âœ… AWS å‡­è¯é…ç½®å®Œæˆ"
        
        echo "ğŸ“Š å½“å‰ S3 å­˜å‚¨æ¡¶å†…å®¹:"
        aws s3 ls s3://${{ secrets.S3_BUCKET }}/deployments/ --human-readable
        
        # Keep only last 5 deployments
        echo "ğŸ—‚ï¸ ä¿ç•™æœ€è¿‘ 5 ä¸ªéƒ¨ç½²æ–‡ä»¶ï¼Œåˆ é™¤å…¶ä»–æ—§æ–‡ä»¶..."
        aws s3 ls s3://${{ secrets.S3_BUCKET }}/deployments/ | sort | head -n -5 | awk '{print $4}' | while read file; do
          if [[ "$file" != "latest.tar.gz" && "$file" != "" ]]; then
            echo "ğŸ—‘ï¸ åˆ é™¤æ—§éƒ¨ç½²æ–‡ä»¶: $file"
            aws s3 rm s3://${{ secrets.S3_BUCKET }}/deployments/$file
          fi
        done
        
        echo "âœ… æ—§éƒ¨ç½²æ–‡ä»¶æ¸…ç†å®Œæˆ"
        echo "ğŸ“Š æ¸…ç†å S3 å­˜å‚¨æ¡¶å†…å®¹:"
        aws s3 ls s3://${{ secrets.S3_BUCKET }}/deployments/ --human-readable 